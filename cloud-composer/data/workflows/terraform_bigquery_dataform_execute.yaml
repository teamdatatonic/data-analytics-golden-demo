# Double "$$" prevent terraform from trying to evaluate code in brackets
main:
  steps:
    - init:
        assign:
          - repository: projects/${project_id}/locations/${region}/repositories/dataform_golden_demo

    # pulls the list of currently running dataform workflows
    - current_invocations:
        call: http.get
        args:
          url: $${"https://dataform.googleapis.com/v1beta1/" + repository + "/workflowInvocations?filter=invocationConfig.includedTags:daily&filter=state:RUNNING"}
          auth:
            type: OAuth2
        result: running_invocations

    # finishes current workflow if dataform is already being invoked
    - decide_to_run:
        switch:
          - condition: $${len(running_invocations.body) > 0}
            next: end

    # fetch and compile dataform wokflow code
    - createCompilationResult:
        call: http.post
        args:
          url: $${"https://dataform.googleapis.com/v1beta1/" + repository + "/compilationResults"}
          auth:
            type: OAuth2
          body:
            gitCommitish: main
        result: compilationResult

    # invoke the dataform workflow
    - createWorkflowInvocation:
        call: http.post
        args:
          url: $${"https://dataform.googleapis.com/v1beta1/" + repository + "/workflowInvocations"}
          auth:
            type: OAuth2
          body:
            compilationResult: $${compilationResult.body.name}
        result: workflowInvocation

    # workflow execution result will be full ID of dataform invocation
    - complete:
        return: $${workflowInvocation.body.name}
